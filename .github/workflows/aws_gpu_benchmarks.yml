name: GPU Benchmarks on AWS EC2 (Reusable)

# This is a reusable workflow that uses machulav/ec2-github-runner to run GPU benchmarks.
# Called by:
#   - pr_target_aws_gpu.yml (for pull requests)

# Workflow configuration variables
env:
  AWS_REGION: us-east-2
  AWS_INSTANCE_TYPE: g6e.2xlarge
  AWS_VOLUME_SIZE: 92
  AWS_VOLUME_TYPE: gp3
  AWS_SECURITY_GROUP_IDS: sg-07807c44e7f2a368a
  AWS_ROLE_ARN: arn:aws:iam::968945269301:role/newton-physics-newton-ec2-github-runner-role
  AWS_ROLE_DURATION: 7200
  HOME: /actions-runner

on:
  workflow_call:
    inputs:
      ref:
        description: 'Git ref to checkout'
        required: true
        type: string
        default: ''
      base_ref:
        description: 'Base ref to compare against (for ASV)'
        required: true
        type: string
        default: ''
    secrets:
      GH_PERSONAL_ACCESS_TOKEN:
        required: true

jobs:
  start-runner:
    name: Start self-hosted EC2 runner
    if: github.repository == 'newton-physics/newton'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      label: ${{ steps.start-ec2-runner.outputs.label }}
      ec2-instance-id: ${{ steps.start-ec2-runner.outputs.ec2-instance-id }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708  # v5.1.1
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          role-duration-seconds: ${{ env.AWS_ROLE_DURATION }}
      - name: Get the latest AWS Deep Learning Base GPU AMI
        run: |
          echo "Finding the latest AWS Deep Learning Base GPU AMI..."
          LATEST_AMI_ID=$(aws ec2 describe-images --region ${{ env.AWS_REGION }} \
            --owners amazon \
            --filters 'Name=name,Values=Deep Learning Base AMI with Single CUDA (Ubuntu 22.04) ????????' 'Name=state,Values=available' \
            --query 'reverse(sort_by(Images, &CreationDate))[:1].ImageId' \
            --output text)
          if [[ -z "$LATEST_AMI_ID" ]]; then
            echo "❌ No AMI ID found. Exiting."
            exit 1
          fi
          echo "Latest AMI ID found: $LATEST_AMI_ID"
          echo "LATEST_AMI_ID=$LATEST_AMI_ID" >> "$GITHUB_ENV"
      - name: Start EC2 runner
        id: start-ec2-runner
        uses: machulav/ec2-github-runner@a6dbcefcf8a31a861f5e078bb153ed332130c512  # v2.4.3
        with:
          mode: start
          github-token: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
          ec2-image-id: ${{ env.LATEST_AMI_ID }}
          ec2-instance-type: ${{ env.AWS_INSTANCE_TYPE }}
          ec2-volume-size: ${{ env.AWS_VOLUME_SIZE }}
          ec2-volume-type: ${{ env.AWS_VOLUME_TYPE }}
          security-group-id: ${{ env.AWS_SECURITY_GROUP_IDS }}
          aws-resource-tags: >
            [
              {"Key": "Name", "Value": "ec2-github-runner"},
              {"Key": "created-by", "Value": "github-actions-newton-role"},
              {"Key": "GitHub-Repository", "Value": "${{ github.repository }}"}
            ]

  gpu-benchmarks:
    name: Run GPU Benchmarks on AWS EC2
    needs: start-runner # required to start the main job when the runner is ready
    runs-on: ${{ needs.start-runner.outputs.label }} # run the job on the newly created runner
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev \
              libgl1-mesa-dev libglu1-mesa-dev
          # Clean up apt cache immediately after install
          sudo apt-get clean

      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867  # v7.1.6
        with:
          version: "0.9.0"

      - name: Set up Python
        run: uv python install

      - name: Check disk space
        run: df -h

      - name: Set up ASV environment
        run: uvx asv machine --yes

      - name: Run Benchmarks
        run: |
          uvx --with virtualenv asv continuous \
            --launch-method spawn \
            --interleave-rounds \
            --append-samples \
            --no-only-changed \
            -e -b Fast \
            ${{ inputs.base_ref }} \
            ${{ inputs.ref }}
        continue-on-error: true
        id: benchmark

      - name: Show comparison on failure
        if: steps.benchmark.outcome == 'failure'
        run: |
          uvx asv compare --split ${{ inputs.base_ref }} ${{ inputs.ref }}
          exit 2

      - name: Check disk space (post-benchmark)
        if: always()
        run: df -h

      - name: Re-run instructions
        if: failure()
        run: |
          # Create error annotations (appear at top of job summary)
          echo "::error::DO NOT use 'Re-run failed jobs' - the EC2 runner no longer exists and your job will be queued forever."
          echo "::error::USE 'Re-run all jobs' instead to start a fresh EC2 runner."

          # Write to job summary (appears in Summary tab)
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ## ⚠️ How to Re-run This Workflow

          This workflow uses **ephemeral EC2 runners** that are terminated after each run.

          | | Option | Result |
          |---|--------|--------|
          | ❌ | **Re-run failed jobs** | Runner no longer exists → job queued forever |
          | ✅ | **Re-run all jobs** | Starts new EC2 runner → benchmarks re-run |
          EOF

          # Also print to log for completeness
          cat << 'EOF'

          ================================================================================
          ⚠️  IMPORTANT: HOW TO RE-RUN THIS WORKFLOW
          ================================================================================

          This workflow uses ephemeral EC2 runners that are terminated after each run.

          ❌ DO NOT select "Re-run failed jobs"
             → The runner no longer exists and your job will be queued forever.

          ✅ DO select "Re-run all jobs"
             → This will start a new EC2 runner and re-run the benchmarks.

          ================================================================================

          EOF

  stop-runner:
    name: Stop self-hosted EC2 runner
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    needs:
      - start-runner
      - gpu-benchmarks
    if: always() && github.repository == 'newton-physics/newton'
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708  # v5.1.1
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          role-duration-seconds: ${{ env.AWS_ROLE_DURATION }}

      - name: Stop EC2 runner
        uses: machulav/ec2-github-runner@a6dbcefcf8a31a861f5e078bb153ed332130c512  # v2.4.3
        with:
          mode: stop
          github-token: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
          label: ${{ needs.start-runner.outputs.label }}
          ec2-instance-id: ${{ needs.start-runner.outputs.ec2-instance-id }}
