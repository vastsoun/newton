name: Deploy release documentation

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: true
        type: string

# Ensure only one deployment runs at a time
concurrency:
  group: docs-deploy
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          fetch-depth: 0  # Need full history for gh-pages branch

      - name: Set version from tag or input
        id: version
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          if [ "$EVENT_NAME" = "push" ]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="$INPUT_VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

          # Only deploy docs for stable releases (strict semver X.Y.Z)
          # Pre-release tags (e.g., 1.0.0-rc.1, 1.0.0-beta) are skipped entirely
          if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "SHOULD_DEPLOY=true" >> $GITHUB_OUTPUT
            echo "Stable release detected: will deploy docs"
          else
            echo "SHOULD_DEPLOY=false" >> $GITHUB_OUTPUT
            echo "Pre-release detected: skipping documentation deployment"
          fi

      - name: Install uv
        if: steps.version.outputs.SHOULD_DEPLOY == 'true'
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867  # v7.1.6
        with:
          version: "0.9.0"

      - name: Set up Python
        if: steps.version.outputs.SHOULD_DEPLOY == 'true'
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.1.0
        with:
          python-version-file: ".python-version"

      - name: Install pandoc
        if: steps.version.outputs.SHOULD_DEPLOY == 'true'
        uses: pandoc/actions/setup@86321b6dd4675f5014c611e05088e10d4939e09e  # v1.1.1

      - name: Build Sphinx documentation
        if: steps.version.outputs.SHOULD_DEPLOY == 'true'
        run: uv run --extra docs --extra sim sphinx-build -b html docs docs/_build/html

      - name: Deploy to gh-pages
        if: steps.version.outputs.SHOULD_DEPLOY == 'true'
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          set -e  # Exit on any error

          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"

          # Save built docs and 404 template outside the repo before switching branches
          mv docs/_build/html /tmp/docs-release
          cp docs/_static/gh-pages-404.html /tmp/gh-pages-404.html

          # Switch to gh-pages branch (check existence first to avoid masking other fetch errors)
          if git ls-remote --exit-code --heads origin gh-pages > /dev/null 2>&1; then
            git fetch origin gh-pages:gh-pages
            git checkout gh-pages
          else
            echo "Creating new gh-pages branch"
            git checkout --orphan gh-pages
            git rm -rf . || true
          fi

          # Deploy version directory (remove old if rebuilding)
          rm -rf "$VERSION"
          mv /tmp/docs-release "$VERSION"

          # Update stable/ directory (copy, not symlink - symlinks unreliable on GH Pages)
          rm -rf stable
          cp -r "$VERSION" stable

          # Update switcher.json (script is in the main branch, not gh-pages)
          # Use origin/main because there's no local main branch on tag-triggered runs
          git show origin/main:scripts/ci/update_docs_switcher.py > /tmp/update_docs_switcher.py
          uv run --no-project /tmp/update_docs_switcher.py "$VERSION"
          rm -f switcher.json.bak

          # Ensure root index.html redirect exists
          {
            echo '<!DOCTYPE html>'
            echo '<html>'
            echo '<head>'
            echo '  <meta charset="utf-8">'
            echo '  <title>Redirecting to Newton Documentation</title>'
            echo '  <meta http-equiv="refresh" content="0; url=stable/">'
            echo '  <link rel="canonical" href="https://newton-physics.github.io/newton/stable/">'
            echo '</head>'
            echo '<body>'
            echo '  <p>Redirecting to <a href="stable/">Newton Documentation</a>...</p>'
            echo '</body>'
            echo '</html>'
          } > index.html

          # Deploy custom 404 page for redirecting old non-versioned URLs
          cp /tmp/gh-pages-404.html 404.html

          # Ensure .nojekyll exists
          touch .nojekyll

          # Check gh-pages size (warn if approaching GitHub Pages 1GB limit)
          SIZE_KB=$(du -sk --exclude=.git . | cut -f1)
          SIZE_MB=$((SIZE_KB / 1024))
          echo "Current gh-pages size: ${SIZE_MB}MB"
          if [ "$SIZE_MB" -gt 800 ]; then
            echo "::warning::gh-pages branch is ${SIZE_MB}MB, approaching GitHub Pages 1GB limit. Consider pruning old versions."
          fi

          # Stage only the files we want deployed (avoid committing build artifacts
          # like .venv/ that persist after switching branches)
          git add "$VERSION" stable switcher.json index.html 404.html .nojekyll
          git diff --cached --quiet || git commit -m "Release v$VERSION documentation"
          git push origin gh-pages
